The script `build-cve-2018-18577.sh` will setup (in the directory $CVE_2018_18577) a NAN Javascript exploit for [CVE-2018-18577](https://nvd.nist.gov/vuln/detail/CVE-2018-18557).

**WARNING!**

The instructions below show how to build a vulerable libtiff but there is a libtiff on the host. The libtiff on the host has the fix for the exploit so it won't work. If node picks up host libtiff you'll see something like this. 

Here I ran it without the LD_LIBRARY_PATH so it uses the host's libtiff
```
elahtinen@pac-thinkstation:~/open5g/CVE-2018-18557/picha$ PATH=/bpjs/bpjs/vanilla_node/node_install/bin:$PATH setarch `uname -m` -R node --expose-gc ./jbig.js 
/home/elahtinen/open5g/CVE-2018-18557/picha/index.js:151
		return new Image(picha.decodeTiffSync(buf, opt || {}));
		                       ^

Error: Decoded 3301 bytes, whereas 2222 were requested
    at Object.exports.decodeTiffSync (/home/elahtinen/open5g/CVE-2018-18557/picha/index.js:151:26)
    at Object.<anonymous> (/home/elahtinen/open5g/CVE-2018-18557/picha/jbig.js:124:23)
    at Module._compile (module.js:643:30)
    at Object.Module._extensions..js (module.js:654:10)
    at Module.load (module.js:556:32)
    at tryModuleLoad (module.js:499:12)
    at Function.Module._load (module.js:491:3)
    at Function.Module.runMain (module.js:684:10)
    at startup (bootstrap_node.js:187:16)
    at bootstrap_node.js:608:3
```

**END WARNING**

We'll be using this exploit
https://www.exploit-db.com/exploits/45694

Libtiff completely ignores the size of the destination buffer writing writing the decoded buffer for jbig decompression.

This NAN module reads tiff files: 

https://www.npmjs.com/package/picha
https://github.com/jhs67/picha

The builds for these libraries automatically configure themselves depending on what packages are available on the system. So you'll need to direct them the various packages. 

First set a root directory for all these packages:

```
mkdir CVE-2018-18557
cd CVE-2018-18557
export CVE_2018_18577=`pwd`
```

Start with the jbig package

```
git clone https://www.cl.cam.ac.uk/~mgk25/git/jbigkit
cd jbigkit
make V=1 -j 10
```

It's a very simple package that just builds itself into `libjbig`

```
elahtinen@pac-thinkstation:~/open5g/CVE-2018-18557/jbigkit/libjbig$ ls
jbig85.c  jbig85.o    jbig_ar.c  jbig_ar.o  jbig.h  jbig.txt     libjbig.a  po        tstcodec85    tstcodec85.o  tstcodec.o  tstjoint.c
jbig85.h  jbig85.txt  jbig_ar.h  jbig.c     jbig.o  libjbig85.a  Makefile   tstcodec  tstcodec85.c  tstcodec.c    tstjoint    tstjoint.o
elahtinen@pac-thinkstation:~/open5g/CVE-2018-18557/jbigkit/libjbig$ 
```

Now build a vulnerable libitff with jbig enabled


```
cd $CVE_2018_18577
git clone https://gitlab.com/libtiff/libtiff.git
cd libtiff
git checkout Release-v4-0-9

```

Now configure libtiff so that is it includes jbig

```
./autogen.sh
CFLAGS="-I$CVE_2018_18577/jbigkit/libjbig" CXXFLAGS=$CFLAGS LDFLAGS="-L$CVE_2018_18577/jbigkit/libjbig" ./configure  --prefix=$CVE_2018_18577/build
```

configure should automatically pick up the jbig build. At the end of the configuration output it should report `ISO JBIG support`: as an external codec with a `yes`
```
...
 Support for external codecs:
  ZLIB support:                       yes
  Pixar log-format algorithm:         yes
  JPEG support:                       yes
  Old JPEG support:                   yes
  JPEG 8/12 bit dual mode:            no
  ISO JBIG support:                   yes
  LZMA2 support:                      no

  C++ support:                        yes

  OpenGL support:                     no
```

Now build libtiff (all the include a libraries path are setup so you don't need them to set them in the environment)

```
make V=1 -j 10 install
```

I seem to have to install nan with each new module:

```
PATH=/bpjs/bpjs/vanilla_node/node_install/bin:$PATH /bpjs/bpjs/vanilla_node/node_install/bin/npm install nan --verbose
```

Build picha directing it to use the libtiff package we just built

```
cd $CVE_2018_18577
git clone https://github.com/jhs67/picha
PATH=/bpjs/bpjs/vanilla_node/node_install/bin:$PATH PKG_CONFIG_PATH=$CVE_2018_18577/build/lib/pkgconfig /bpjs/bpjs/vanilla_node/node_install/bin/npm build --verbose picha
```

I don't know why you needed to build this one from one directory up from the git repository, but you do

You'll need these two files from the repro:
```
cp .../exploits/CVE-2018-18577/jbig.js $CVE_2018_18577/picha/
cp .../exploits/CVE-2018-18577/jbig-crash.tif $CVE_2018_18577/picha/
```

Now you are ready to run! You need to point node at the libtiff you've just built. You also need to expose the garbage collector to make sure the exploit works consistently

```
cd $CVE_2018_18577/picha
PATH=/bpjs/bpjs/vanilla_node/node_install/bin:$PATH LD_LIBRARY_PATH=$CVE_2018_18577/build/lib setarch `uname -m` -R node --expose-gc ./jbig.js
The exploit will execute touch /tmp/require-security-bjpeg.txt so you should see the file `/tmp/require-security-bjpeg.txt`
Of course to verify the exploit worked: delete the file, run the exploit and check if the file exists:
rm -r /tmp/require-security-bjpeg.txt && PATH=/bpjs/bpjs/vanilla_node/node_install/bin:$PATH LD_LIBRARY_PATH=$CVE_2018_18577/build/lib setarch `uname -m` -R node --expose-gc ./jbig.js || ls -l /tmp/require-security-bjpeg.txt
```


I expect the exploit to work every time. With any heap exploit there is a small chance a single run might fail; but you really shouldn't see more than one failure in a row.

Also the exploit is only likely to work against `/bpjs/bpjs/vanilla_node/node_install/bin/node`.
